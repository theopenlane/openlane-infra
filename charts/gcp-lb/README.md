# GCP Load Balancer and Ingress Helm Chart (CNRM)

This Helm chart provisions a production-grade external HTTP(S) Load Balancer, including URL mapping, Backend Services, Health Checks, and SSL policies using **GCP Config Connector**. This LB is typically used for ingress into GKE services.

**Key Features:**

*   **HTTPS Enforcement:** Configured to redirect HTTP traffic to HTTPS.
*   **Managed SSL Certificates:** Integration with GCP's managed SSL certificates (requires domain ownership verification through DNS).
*   **Robust Backend Configuration:** Detailed settings for backend services and health checks targeting GKE NodePorts.
*   **SSL Policy:** Apply modern TLS versions for secure connections.

## Usage

This chart depends on a pre-existing DNS Managed Zone from the `gcp-dns` chart and an existing GKE cluster with a service exposed via NodePort. The NodePort service will be the target of the Backend Service.

## Values

Review the `values.yaml` for configurable parameters.

### Important Notes

*   **Managed SSL Certificate:** For the `ComputeManagedSslCertificate` resource, you **must** ensure your domain's DNS is configured to point to the Load Balancer's external IP once provisioned. GCP performs domain ownership verification before issuing the certificate. This verification is crucial and might take time.
*   **Backend Service Target:** The `backendService.backends.groupRef` must point to an InstanceGroup or NetworkEndpointGroup created by your GKE cluster. This is typically dynamically generated by GKE for NodePorts. You might need to retrieve this dynamically or obtain it after cluster creation.
*   **`projectId`:** Ensure the `projectId` is consistently set across all Load Balancer resources.


**Conceptual `charts/gcp-lb-ingress/templates/`**
*   All resources now use `compute.cnrm.cloud.google.com/v1beta1` API versions.
*   `ComputeGlobalAddress`: `projectRef.external`.
*   `ComputeManagedSslCertificate`: `projectRef.external`, `domains`.
*   `ComputeSslPolicy`: `projectRef.external`.
*   `ComputeHealthCheck`: `projectRef.external`.
*   `ComputeBackendService`: `projectRef.external`, `backends.groupRef.external` (this will need careful handling as GKE instance group names are dynamic).
*   `ComputeURLMap`, `ComputeTargetHttpProxy`, `ComputeTargetHttpsProxy`, `ComputeGlobalForwardingRule`: All use `projectRef.external` and `external` references to other CNRM resources by name.