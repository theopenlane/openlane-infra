# GCP CloudSQL (PostgreSQL) Helm Chart (CNRM)

This Helm chart provisions a production-grade CloudSQL PostgreSQL instance, databases, and users using **GCP Config Connector**.

**Key Features:**

*   **Private IP by Default:** Connects to your VPC network for secure internal access.
*   **High Availability:** Configurable for regional HA.
*   **Automated Backups & Maintenance:** Ensures data durability and instance health.
*   **Security:** Enforces SSL for connections, offers database flags for hardening, and password policies.
*   **User Management:** Creates database users and handles their passwords via Kubernetes Secrets.

## Usage

This chart depends on a pre-existing VPC network from the `gcp-vpc` chart for private IP connectivity.
Ensure the referenced network exists before deploying.

## Values

Review the `values.yaml` for configurable parameters.

### Important Notes

*   **Passwords:** Passwords for database users can be automatically generated by Config Connector and stored in Kubernetes Secrets. Manage these secrets securely.
*   **SSL:** It is highly recommended to enforce SSL for all CloudSQL connections (`requireSsl: true`).

**Conceptual `charts/gcp-cloudsql/templates/`
*   `instance.yaml`: Defines `SQLInstance` CR (`sql.cnrm.cloud.google.com/v1beta1.SQLInstance`). Key changes: `projectRef.external`, `region` field, `ipConfiguration.privateNetworkRef.external` for private IPs, robust `settings` (tier, HA, backup, maintenance, flags, `requireSsl: true`).
*   `database.yaml`: Iterates `values.databases.items` to create `SQLDatabase` CRs (`sql.cnrm.cloud.google.com/v1beta1.SQLDatabase`), referencing `instanceRef.external`.
*   `user.yaml`: Iterates `values.users.items` to create `SQLUser` CRs (`sql.cnrm.cloud.google.com/v1beta1.SQLUser`), referencing `instanceRef.external` and using `passwordSecretRef` to get passwords from K8s secrets.
*   `ssl-cert.yaml`: Defines `SQLSSLCert` CR (`sql.cnrm.cloud.google.com/v1beta1.SQLSSLCert`) to fetch the CloudSQL root certificate, storing it in a K8s secret.